{% extends "base.html" %}
{% load static %}

{% block title %}Track Order #{{ order.id }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto p-4">
  <h2 class="text-xl font-semibold mb-2">Order {{ order.id }} Tracking</h2>

  <div class="text-sm text-gray-600 mb-3 flex items-center gap-3">
    <span>
      Status:
      <span data-status-chip class="inline-flex items-center rounded px-2 py-0.5 bg-gray-100">
        {% if delivery %}
          {{ delivery.get_status_display|default_if_none:delivery.status }}
        {% else %}-{% endif %}
      </span>
    </span>
    <span class="hidden md:inline">•</span>
    <span>
      ETA:
      <span data-eta-badge class="inline-flex items-center rounded px-2 py-0.5 bg-orange-100 text-orange-700">-</span>
    </span>
  </div>

  <div
    id="map"
    class="w-full rounded-lg border"
    style="height: 400px;"
    {% if delivery %}data-delivery-id="{{ delivery.id }}"{% endif %}
  ></div>

  <noscript class="block mt-3 text-sm text-red-700">
    Enable JavaScript to see live tracking.
  </noscript>

  {% if not delivery %}
    <p class="mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
      No delivery assigned yet for this order, so live tracking is disabled.
    </p>
  {% endif %}
</div>

{# Leaflet (once) #}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{# Safe JSON payload; renders as <script type="application/json" id="route-ctx">…</script> #}
{{ route_ctx|json_script:"route-ctx" }}

{# Bootstrap a usable context for tracking-route.js (CSP-safe via nonce) #}
<script nonce="{{ request.csp_nonce }}">
  (function () {
    let ctx = {};
    try {
      const node = document.getElementById('route-ctx');
      ctx = node ? JSON.parse(node.textContent || '{}') : {};
    } catch (_) { ctx = {}; }

    // Build wsUrl if the view didn't provide one
    const mapEl = document.getElementById('map');
    const deliveryId = mapEl && mapEl.dataset ? mapEl.dataset.deliveryId : null;
    if (!ctx.wsUrl && deliveryId) {
      const scheme = (location.protocol === 'https:') ? 'wss' : 'ws';
      ctx.wsUrl = `${scheme}://${location.host}/ws/delivery/track/${deliveryId}/`;
    }

    // Expose for your tracking script (support both keys)
    window.__ROUTE_CTX__ = ctx;
    window.route_ctx = ctx;
  })();
</script>

{# Your map/WS bootstrap (matches the script you shared earlier) #}
<script defer src="{% static 'js/tracking-route.js' %}"></script>
{% endblock %}
