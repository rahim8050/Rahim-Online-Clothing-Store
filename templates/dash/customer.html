{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="py-6">
  <h1 class="text-2xl font-bold mb-4">Dashboard</h1>

  {# Show Apply card only if user is logged in and NOT vendor/staff #}
  {% if request.user.is_authenticated %}
    {% if not user_is_vendor and not user_is_vendor_staff and request.user.role != "vendor" and request.user.role != "vendor_staff" %}
      <div id="vendor-apply-card"
           class="bg-white rounded-2xl border shadow-sm overflow-hidden"
           data-apply-endpoint="{% url 'apis:vendor-apply' %}">
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="font-semibold">Become a Vendor</h2>
        </div>

        <div class="p-4 space-y-2">
          {% with status=vendor_app_status|default:"none"|lower %}
            <div id="vendor-apply-status"
                 class="text-sm text-gray-600"
                 aria-live="polite">
              {% if status == "pending" %}
                Your application is <span class="font-medium">pending review</span>.
              {% elif status == "approved" %}
                Approved ✅ —
                <a href="{% url 'vendor-dashboard' %}" class="text-blue-600 underline">
                  Go to Vendor Dashboard
                </a>
              {% elif status == "rejected" %}
                Application was rejected. You may re-apply.
              {% else %}
                Apply to open your own shop and manage products, orders, and payouts.
              {% endif %}
            </div>

            {% if status == "none" or status == "rejected" %}
              <form id="vendor-apply-form" class="space-y-3 mt-3" enctype="multipart/form-data" method="post">
                {% csrf_token %}
                <div>
                  <label class="block text-sm font-medium">Company name</label>
                  <input name="company_name" class="mt-1 w-full rounded border px-3 py-2" required />
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium">Phone</label>
                    <input name="phone" class="mt-1 w-full rounded border px-3 py-2" required />
                  </div>
                  <div>
                    <label class="block text-sm font-medium">KRA PIN</label>
                    <input name="kra_pin" class="mt-1 w-full rounded border px-3 py-2" placeholder="A123456789B" required />
                  </div>
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium">National ID</label>
                    <input name="national_id" class="mt-1 w-full rounded border px-3 py-2" required />
                  </div>
                  <div>
                    <label class="block text-sm font-medium">KYC document (PDF/JPG/PNG)</label>
                    <input type="file" name="document" accept=".pdf,.jpg,.jpeg,.png" class="mt-1 w-full" required />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium">Note (optional)</label>
                  <textarea name="note" rows="2" class="mt-1 w-full rounded border px-3 py-2"></textarea>
                </div>
                <div class="pt-2">
                  <button id="btn-apply-vendor" class="px-4 py-2 rounded-xl text-white bg-gray-900 disabled:opacity-50">
                    {% if status == "rejected" %}Re-apply{% else %}Submit application{% endif %}
                  </button>
                  <span id="vendor-apply-hint" class="ml-3 text-xs text-gray-500"></span>
                </div>
              </form>
            {% else %}
              <div class="pt-2">
                <button id="btn-apply-vendor"
                        class="px-4 py-2 rounded-xl text-white bg-gray-900 opacity-50 cursor-not-allowed"
                        disabled>
                  {% if status == "pending" %}Application Submitted{% elif status == "approved" %}Approved{% endif %}
                </button>
                <span id="vendor-apply-hint" class="ml-3 text-xs text-gray-500"></span>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    {% endif %}
  {% endif %}

  {# Other dashboard widgets #}
  <div class="mt-6 grid gap-4 md:grid-cols-2">
    <div class="bg-white rounded-xl border p-4">
      <h3 class="font-semibold mb-2">Recent Orders</h3>
      <p class="text-sm text-gray-600">Coming soon…</p>
    </div>
    <div class="bg-white rounded-xl border p-4">
      <h3 class="font-semibold mb-2">Account</h3>
      <p class="text-sm text-gray-600">Welcome, {{ request.user.get_username }}.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/customer_vendor_apply.js' %}" defer></script>
{% endblock %}
