{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Vendor Dashboard</h1>

  <!-- Your inventory (server-rendered from users.views.vendor_dashboard) -->
  <h2 class="text-lg font-semibold mb-2">My products ({{ products|length }})</h2>
  {% if products %}
    <div class="grid md:grid-cols-3 gap-4 mb-8">
      {% for p in products %}
        <div class="border rounded-xl p-4 bg-white">
          <h3 class="font-semibold">{{ p.name }}</h3>
          <p class="text-sm text-gray-600">KSh {{ p.price }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 mb-8">You haven’t listed any products yet.</p>
  {% endif %}

  <!-- Shop from other vendors (Vue app) -->
  <h2 class="text-lg font-semibold mb-2">Shop from other vendors</h2>
  <div id="vendor-shop"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

{% verbatim %}
<script>
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

new Vue({
  el: '#vendor-shop',
  delimiters: ['[[', ']]'],
  data: {
    items: [],
    q: '',
    next: null,
    prev: null,
    addingId: null,
    loading: false,
    error: ''
  },
  mounted(){ this.load(); },
  methods: {
    fmt(v){ return Number(v || 0).toLocaleString(); },
    async load(url){
      this.loading = true; this.error = '';
      try{
        const base = '/apis/vendor/shopable-products/';   // if your project uses /api/, change to '/api/...'
        const u = url || `${base}?q=${encodeURIComponent(this.q)}`;
        const res = await fetch(u, { credentials: 'same-origin' });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const d = await res.json();
        this.items = d.results || d;
        this.next = d.next || null;
        this.prev = d.previous || null;
      }catch(e){
        this.error = e.message || 'Failed to load products';
      }finally{
        this.loading = false;
      }
    },
    go(url){ if(url) this.load(url); },
    async addToCart(id){
      try{
        this.addingId = id;
        const res = await fetch(`/cart/add/${id}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          credentials: 'same-origin'
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.success === false){
          throw new Error(data.message || 'Add to cart failed');
        }
        window.dispatchEvent(new CustomEvent('cart:updated'));
      }catch(e){
        alert(e.message || 'Add-to-cart failed');
      }finally{
        this.addingId = null;
      }
    }
  },
  template: `
    <div>
      <div class="mb-4 flex gap-2">
        <input v-model="q" @keyup.enter="load()" placeholder="Search"
               class="border rounded px-3 py-2 w-full" />
        <button @click="load()" class="px-4 py-2 rounded bg-black text-white">Search</button>
      </div>

      <div v-if="error" class="text-red-600 mb-3">[[ error ]]</div>
      <div v-else-if="loading" class="text-gray-500">Loading…</div>
      <div v-else-if="!items.length" class="text-gray-500">No products from other vendors yet.</div>

      <div v-else class="grid md:grid-cols-3 gap-4">
        <div v-for="p in items" :key="p.id" class="border rounded-xl p-4 bg-white">
          <h3 class="font-semibold">[[ p.name ]]</h3>
          <p class="text-sm mb-2">KSh [[ fmt(p.price) ]]</p>
          <button
            :disabled="p.owned_by_me || addingId===p.id"
            @click="addToCart(p.id)"
            class="mt-2 px-3 py-2 rounded w-full"
            :class="p.owned_by_me ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white'">
            [[ p.owned_by_me ? 'Your listing' : (addingId===p.id ? 'Adding…' : 'Add to cart') ]]
          </button>
        </div>
      </div>

      <div class="mt-6 flex justify-center gap-2" v-if="next || prev">
        <button @click="go(prev)" :disabled="!prev" class="px-3 py-2 border rounded">Prev</button>
        <button @click="go(next)" :disabled="!next" class="px-3 py-2 border rounded">Next</button>
      </div>
    </div>
  `
});
</script>
{% endverbatim %}
{% endblock %}
