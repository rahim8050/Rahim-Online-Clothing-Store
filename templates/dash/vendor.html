{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto p-4 space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">Vendor Dashboard</h1>
    <div class="flex items-center gap-2">
      <a href="/apis/vendor/deliveries/" class="px-3 py-1.5 rounded bg-black text-white text-sm">Live Board</a>
    </div>
  </div>

  <!-- Stats (from users.views.vendor_dashboard) -->
  <div class="grid sm:grid-cols-3 gap-3">
    <div class="rounded-xl border bg-white p-4">
      <div class="text-xs text-gray-500">Products</div>
      <div class="text-2xl font-semibold">{{ stats.products_total|default:0 }}</div>
    </div>
    <div class="rounded-xl border bg-white p-4">
      <div class="text-xs text-gray-500">Active</div>
      <div class="text-2xl font-semibold">{{ stats.active_products|default:0 }}</div>
    </div>
    <div class="rounded-xl border bg-white p-4">
      <div class="text-xs text-gray-500">Order items</div>
      <div class="text-2xl font-semibold">{{ stats.order_items_total|default:0 }}</div>
    </div>
  </div>

  <!-- Products (server-rendered) -->
  <section>
    <h2 class="text-lg font-semibold mb-2">My products ({{ products|length }})</h2>
    {% if products %}
      <div class="grid md:grid-cols-3 gap-4 mb-2">
        {% for p in products %}
          <div class="border rounded-xl p-4 bg-white">
            <h3 class="font-semibold">{{ p.name }}</h3>
            <p class="text-sm text-gray-600">KSh {{ p.price }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500">No products yet.</p>
    {% endif %}
  </section>

  <!-- Live deliveries (vendor scope) -->
  <section>
    <h2 class="text-lg font-semibold mb-2">Active deliveries</h2>
    <div id="vendor-deliveries"></div>
  </section>

  <!-- Staff management -->
  <section>
    <h2 class="text-lg font-semibold mb-2">Staff</h2>
    <div id="vendor-staff"></div>
  </section>

  <!-- Shop from other vendors (optional) -->
  <section>
    <h2 class="text-lg font-semibold mb-2">Shop from other vendors</h2>
    <div id="vendor-shop"></div>
  </section>
</div>

<!-- Vue 2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

<!-- Set assistant role early on this page -->
<script>
  (function () {
    var m = document.getElementById('rahim-assistant-mount');
    if (m) m.dataset.role = 'vendor';
  })();
</script>

<!-- ===== Vue x-templates (no JS backticks here) ===== -->

<script type="text/x-template" id="tpl-vendor-deliveries">
  <div class="rounded-xl border bg-white overflow-hidden">
    <div v-if="error" class="p-3 text-red-600">[[ error ]]</div>
    <div v-else>
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left">Delivery</th>
            <th class="px-3 py-2 text-left">Order</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Driver</th>
            <th class="px-3 py-2 text-left">Assigned</th>
            <th class="px-3 py-2 text-left">Last Ping</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="d in rows" :key="d.id" class="border-t">
            <td class="px-3 py-2"># [[ d.id ]]</td>
            <td class="px-3 py-2"># [[ d.order_id ]]</td>
            <td class="px-3 py-2">[[ d.status ]]</td>
            <td class="px-3 py-2">[[ d.driver_id || '—' ]]</td>
            <td class="px-3 py-2">[[ fmt(d.assigned_at) ]]</td>
            <td class="px-3 py-2">[[ fmt(d.last_ping_at) ]]</td>
            <td class="px-3 py-2">
              <div class="flex items-center gap-1">
                <input v-model="assignId[d.id]" placeholder="driver id" class="w-24 border rounded px-2 py-1 text-xs"/>
                <button @click="assign(d)" :disabled="busy[d.id]" class="px-2 py-1 rounded bg-blue-600 text-white text-xs">Assign</button>
                <button @click="unassign(d)" :disabled="busy[d.id]" class="px-2 py-1 rounded bg-gray-600 text-white text-xs">Unassign</button>
                <!-- Safe concatenation -->
                <a :href="'/orders/orders/' + d.order_id + '/track/'" class="ml-2 text-xs text-blue-600 underline">Track</a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</script>

<script type="text/x-template" id="tpl-vendor-staff">
  <div class="rounded-xl border bg-white p-3">
    <div v-if="error" class="text-red-600">[[ error ]]</div>
    <div class="mb-2 flex items-center gap-2">
      <input v-model="staffId" placeholder="Staff user id" class="border rounded px-2 py-1 text-sm"/>
      <select v-model="role" class="border rounded px-2 py-1 text-sm">
        <option value="staff">Staff</option>
        <option value="owner">Owner</option>
      </select>
      <button @click="add()" :disabled="busy" class="px-3 py-1.5 rounded bg-black text-white text-sm">Add</button>
    </div>
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-2 py-1 text-left">ID</th>
          <th class="px-2 py-1 text-left">Owner</th>
          <th class="px-2 py-1 text-left">Staff</th>
          <th class="px-2 py-1 text-left">Role</th>
          <th class="px-2 py-1 text-left">Active</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="s in list" :key="s.id" class="border-t">
          <td class="px-2 py-1">[[ s.id ]]</td>
          <td class="px-2 py-1">[[ s.owner ]]</td>
          <td class="px-2 py-1">[[ s.staff ]]</td>
          <td class="px-2 py-1">[[ s.role ]]</td>
          <td class="px-2 py-1">[[ s.is_active ? 'Yes' : 'No' ]]</td>
        </tr>
      </tbody>
    </table>
  </div>
</script>

<script type="text/x-template" id="tpl-vendor-shop">
  <div>
    <div class="mb-4 flex gap-2">
      <input v-model="q" @keyup.enter="load()" placeholder="Search" class="border rounded px-3 py-2 w-full" />
      <button @click="load()" class="px-4 py-2 rounded bg-black text-white">Search</button>
    </div>
    <div v-if="error" class="text-red-600 mb-3">[[ error ]]</div>
    <div v-else-if="loading" class="text-gray-500">Loading…</div>
    <div v-else-if="!items.length" class="text-gray-500">No products from other vendors yet.</div>
    <div v-else class="grid md:grid-cols-3 gap-4">
      <div v-for="p in items" :key="p.id" class="border rounded-xl p-4 bg-white">
        <h3 class="font-semibold">[[ p.name ]]</h3>
        <p class="text-sm mb-2">KSh [[ fmt(p.price) ]]</p>
        <button
          :disabled="p.owned_by_me || addingId===p.id"
          @click="addToCart(p.id)"
          class="mt-2 px-3 py-2 rounded w-full"
          :class="p.owned_by_me ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white'">
          [[ p.owned_by_me ? 'Your listing' : (addingId===p.id ? 'Adding…' : 'Add to cart') ]]
        </button>
      </div>
    </div>
    <div class="mt-6 flex justify-center gap-2" v-if="next || prev">
      <button @click="go(prev)" :disabled="!prev" class="px-3 py-2 border rounded">Prev</button>
      <button @click="go(next)" :disabled="!next" class="px-3 py-2 border rounded">Next</button>
    </div>
  </div>
</script>

<!-- ===== Vue apps (safe JS, no backticks in templates) ===== -->

<script>
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

// Deliveries
new Vue({
  el: '#vendor-deliveries',
  delimiters: ['[[', ']]'],
  template: '#tpl-vendor-deliveries',
  data: { rows: [], loading: false, error: '', owner: (new URLSearchParams(location.search)).get('owner_id')||'', assignId: {}, busy:{} },
  mounted(){ this.load(); },
  methods: {
    fmt(dt){ if(!dt) return '—'; try { return new Date(dt).toLocaleString(); } catch(_) { return dt; } },
    async load(){
      this.loading = true; this.error='';
      try{
        const u = new URL('/apis/vendor/deliveries/', location.origin);
        if (this.owner) u.searchParams.set('owner_id', this.owner);
        const r = await fetch(u, { credentials:'same-origin' });
        if(!r.ok){ throw new Error('HTTP '+r.status); }
        this.rows = await r.json();
      }catch(e){ this.error = e.message || 'Failed to load'; }
      finally{ this.loading=false; }
    },
    async assign(d){
      const id=d.id, driver = Number(this.assignId[id]); if(!driver){ alert('Enter driver id'); return; }
      this.$set(this.busy, id, true);
      try{
        const r = await fetch(`/apis/deliveries/${id}/assign/`, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
          credentials:'same-origin',
          body: JSON.stringify({ driver_id: driver })
        });
        if(!r.ok) throw new Error(await r.text());
        const j = await r.json(); d.status = j.status; d.driver_id = j.driver; d.assigned_at = j.assigned_at || d.assigned_at;
      }catch(e){ alert('Assign failed: '+ (e.message||e)); }
      finally{ this.$set(this.busy, id, false); }
    },
    async unassign(d){
      const id=d.id; this.$set(this.busy, id, true);
      try{
        const r = await fetch(`/apis/deliveries/${id}/unassign/`, {
          method:'POST',
          headers:{'X-CSRFToken': getCookie('csrftoken')},
          credentials:'same-origin'
        });
        if(!r.ok) throw new Error(await r.text());
        const j = await r.json(); d.status = j.status; d.driver_id = null; d.assigned_at = null;
      }catch(e){ alert('Unassign failed: '+ (e.message||e)); }
      finally{ this.$set(this.busy, id, false); }
    }
  }
});

// Staff
new Vue({
  el: '#vendor-staff',
  delimiters: ['[[', ']]'],
  template: '#tpl-vendor-staff',
  data: { list: [], email:'', staffId:'', role:'staff', owner:(new URLSearchParams(location.search)).get('owner_id')||'', loading:false, error:'', busy:false },
  mounted(){ this.load(); },
  methods:{
    async load(){
      this.loading=true; this.error='';
      try{
        const u = new URL('/apis/vendor/staff/', location.origin);
        if (this.owner) u.searchParams.set('owner_id', this.owner);
        const r = await fetch(u, { credentials:'same-origin' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        this.list = await r.json();
      }catch(e){ this.error=e.message||'Failed'; }
      finally{ this.loading=false; }
    },
    async add(){
      const payload = { staff_id: Number(this.staffId)||0, role: this.role };
      if(!payload.staff_id){ alert('Enter staff user id'); return; }
      this.busy=true;
      try{
        const r = await fetch('/apis/vendor/staff/', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
          credentials:'same-origin',
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error(await r.text());
        await this.load(); this.staffId='';
      }catch(e){ alert('Add staff failed: '+(e.message||e)); }
      finally{ this.busy=false; }
    }
  }
});

// Shop other vendors
new Vue({
  el: '#vendor-shop',
  delimiters: ['[[', ']]'],
  template: '#tpl-vendor-shop',
  data: { items: [], q: '', next:null, prev:null, addingId:null, loading:false, error:'' },
  mounted(){ this.load(); },
  methods: {
    fmt(v){ return Number(v || 0).toLocaleString(); },
    async load(url){
      this.loading = true; this.error = '';
      try{
        const base = '/apis/vendor/shopable-products/';
        const u = url || `${base}?q=${encodeURIComponent(this.q)}`;
        const res = await fetch(u, { credentials: 'same-origin' });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const d = await res.json();
        this.items = d.results || d; this.next = d.next || null; this.prev = d.previous || null;
      }catch(e){ this.error = e.message || 'Failed to load products'; }
      finally{ this.loading = false; }
    },
    go(url){ if(url) this.load(url); },
    async addToCart(id){
      try{
        this.addingId = id;
        const res = await fetch(`/cart/add/${id}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          credentials: 'same-origin'
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.success === false){ throw new Error(data.message || 'Add to cart failed'); }
        window.dispatchEvent(new CustomEvent('cart:updated'));
      }catch(e){ alert(e.message || 'Add-to-cart failed'); }
      finally{ this.addingId = null; }
    }
  }
});
</script>
{% endblock %}
