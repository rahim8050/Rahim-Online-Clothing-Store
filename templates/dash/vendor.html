{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="max-w-7xl mx-auto p-4 space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">Vendor Dashboard</h1>
    <div class="flex items-center gap-2">
      <a href="/vendor/live-board/" class="px-3 py-1.5 rounded bg-black text-white text-sm">Live Board</a>
    </div>
  </div>

  <!-- Stats (server-rendered) -->
  <div class="grid sm:grid-cols-3 gap-3">
    <div class="rounded-xl border bg-white p-4">
      <div class="text-xs text-gray-500">Products</div>
      <div class="text-2xl font-semibold">{{ stats.products_total|default:0 }}</div>
    </div>
    <div class="rounded-xl border bg-white p-4">
      <div class="text-xs text-gray-500">Active</div>
      <div class="text-2xl font-semibold">{{ stats.active_products|default:0 }}</div>
    </div>
    <div class="rounded-xl border bg-white p-4">
      <div class="text-xs text-gray-500">Order items</div>
      <div class="text-2xl font-semibold">{{ stats.order_items_total|default:0 }}</div>
    </div>
  </div>

  <!-- Products (server-rendered) -->
  <section>
    <h2 class="text-lg font-semibold mb-2">My products ({{ products|length }})</h2>
    {% if products %}
      <div class="grid md:grid-cols-3 gap-4 mb-2">
        {% for p in products %}
          <div class="border rounded-xl p-4 bg-white">
            <h3 class="font-semibold">{{ p.name }}</h3>
            <p class="text-sm text-gray-600">KSh {{ p.price }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500">No products yet.</p>
    {% endif %}
  </section>

  <!-- Live deliveries (Vue 3 ESM) -->
  <section>
    <h2 class="text-lg font-semibold mb-2">Active deliveries</h2>
    <div id="vendor-deliveries"></div>
  </section>

  <!-- Staff management -->
  <section>
    <h2 class="text-lg font-semibold mb-2">Staff</h2>
    <div id="vendor-staff"></div>
  </section>

  <!-- Shop from other vendors -->
  <section>
    <h2 class="text-lg font-semibold mb-2">Shop from other vendors</h2>
    <div id="vendor-shop"></div>
  </section>
</div>

<!-- ESM entry (no CDN, no inline JS) -->
<script type="module" src="{% static 'js/vendor-dashboard.esm.js' %}"></script>

<!-- ===== Vue templates (safe; no scripts executed) ===== -->
<template id="tpl-vendor-deliveries">
  <div class="rounded-xl border bg-white overflow-hidden">
    <div v-if="error" class="p-3 text-red-600">[[ error ]]</div>
    <div v-else>
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left">Delivery</th>
            <th class="px-3 py-2 text-left">Order</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Driver</th>
            <th class="px-3 py-2 text-left">Assigned</th>
            <th class="px-3 py-2 text-left">Last Ping</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="d in rows" :key="d.id" class="border-t">
            <td class="px-3 py-2"># [[ d.id ]]</td>
            <td class="px-3 py-2"># [[ d.order_id ]]</td>
            <td class="px-3 py-2">[[ d.status ]]</td>
            <td class="px-3 py-2">[[ d.driver_id || '—' ]]</td>
            <td class="px-3 py-2">[[ fmt(d.assigned_at) ]]</td>
            <td class="px-3 py-2">[[ fmt(d.last_ping_at) ]]</td>
            <td class="px-3 py-2">
              <div class="flex items-center gap-1">
                <input v-model="assignId[d.id]" placeholder="driver id" class="w-24 border rounded px-2 py-1 text-xs"/>
                <button @click="assign(d)" :disabled="busy[d.id]" class="px-2 py-1 rounded bg-blue-600 text-white text-xs">Assign</button>
                <button @click="unassign(d)" :disabled="busy[d.id]" class="px-2 py-1 rounded bg-gray-600 text-white text-xs">Unassign</button>
                <a :href="'/orders/orders/' + d.order_id + '/track/'" class="ml-2 text-xs text-blue-600 underline">Track</a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</template>

<template id="tpl-vendor-staff">
  <div class="rounded-xl border bg-white p-3">
    <div v-if="error" class="text-red-600">[[ error ]]</div>
    <div class="mb-2 flex items-center gap-2">
      <input v-model="staffId" placeholder="Staff user id" class="border rounded px-2 py-1 text-sm"/>
      <select v-model="role" class="border rounded px-2 py-1 text-sm">
        <option value="staff">Staff</option>
        <option value="owner">Owner</option>
      </select>
      <button @click="add()" :disabled="busy" class="px-3 py-1.5 rounded bg-black text-white text-sm">Add</button>
    </div>
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-2 py-1 text-left">ID</th>
          <th class="px-2 py-1 text-left">Owner</th>
          <th class="px-2 py-1 text-left">Staff</th>
          <th class="px-2 py-1 text-left">Role</th>
          <th class="px-2 py-1 text-left">Active</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="s in list" :key="s.id" class="border-t">
          <td class="px-2 py-1">[[ s.id ]]</td>
          <td class="px-2 py-1">[[ s.owner ]]</td>
          <td class="px-2 py-1">[[ s.staff ]]</td>
          <td class="px-2 py-1">[[ s.role ]]</td>
          <td class="px-2 py-1">[[ s.is_active ? 'Yes' : 'No' ]]</td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<template id="tpl-vendor-shop">
  <div>
    <div class="mb-4 flex gap-2">
      <input v-model="q" @keyup.enter="load()" placeholder="Search" class="border rounded px-3 py-2 w-full" />
      <button @click="load()" class="px-4 py-2 rounded bg-black text-white">Search</button>
    </div>
    <div v-if="error" class="text-red-600 mb-3">[[ error ]]</div>
    <div v-else-if="loading" class="text-gray-500">Loading…</div>
    <div v-else-if="!items.length" class="text-gray-500">No products from other vendors yet.</div>
    <div v-else class="grid md:grid-cols-3 gap-4">
      <div v-for="p in items" :key="p.id" class="border rounded-xl p-4 bg-white">
        <h3 class="font-semibold">[[ p.name ]]</h3>
        <p class="text-sm mb-2">KSh [[ fmt(p.price) ]]</p>
        <button
          :disabled="p.owned_by_me || addingId===p.id"
          @click="addToCart(p.id)"
          class="mt-2 px-3 py-2 rounded w-full"
          :class="p.owned_by_me ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 text-white'">
          [[ p.owned_by_me ? 'Your listing' : (addingId===p.id ? 'Adding…' : 'Add to cart') ]]
        </button>
      </div>
    </div>
    <div class="mt-6 flex justify-center gap-2" v-if="next || prev">
      <button @click="go(prev)" :disabled="!prev" class="px-3 py-2 border rounded">Prev</button>
      <button @click="go(next)" :disabled="!next" class="px-3 py-2 border rounded">Next</button>
    </div>
  </div>
</template>
{% endblock %}
