{% extends "base.html" %}
{% load static %}

{% block content %}
<<<<<<< HEAD

  <h2 class="text-xl font-semibold mb-2">Order {{ order.id }} Tracking</h2>
  <div class="text-sm text-gray-600 mb-3">Status: {% if delivery %}{{ delivery.status }}{% else %}—{% endif %}</div>

  <div id="map" style="height: 400px;"></div>

  <!-- Leaflet (keep versions consistent) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Route context: must be JSON from json.dumps(...) -->
  <script>
    // IMPORTANT: In your view, set route_ctx["wsUrl"] to `/ws/delivery/track/{{ delivery.id }}/`
    window.__ROUTE_CTX__ = {{ route_ctx|safe }};
  </script>

  <!-- Your map/WS bootstrap -->

=======
>>>>>>> development
  <div class="max-w-5xl mx-auto p-4">
    <h2 class="text-xl font-semibold mb-2">Order {{ order.id }} Tracking</h2>

    <div class="text-sm text-gray-600 mb-3 flex items-center gap-3">
      <span>
        Status:
      <span data-status-chip class="inline-flex items-center rounded px-2 py-0.5 bg-gray-100">
        {% if delivery %}
          {{ delivery.get_status_display|default_if_none:delivery.status }}
        {% else %}
          -
        {% endif %}
      </span>
      </span>
      <span class="hidden md:inline">•</span>
      <span>
        ETA:
        <span data-eta-badge class="inline-flex items-center rounded px-2 py-0.5 bg-orange-100 text-orange-700">-</span>
      </span>
    </div>

    <div
      id="map"
      class="w-full rounded-lg border"
      style="height: 400px;"
      {% if delivery %} data-delivery-id="{{ delivery.id }}"{% endif %}
    ></div>

    {% if not delivery %}
      <p class="mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
        No delivery assigned yet for this order, so live tracking is disabled.
      </p>
    {% endif %}
  </div>

  {# Leaflet CSS/JS kept here to ensure it loads on this page even if base.html has no extra_head/extra_js blocks #}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


  <!-- Route context: must be JSON from json.dumps(...) -->
  <script nonce="{{ request.csp_nonce }}">
    // IMPORTANT: In your view, set route_ctx["wsUrl"] to `/ws/delivery/track/{{ delivery.id }}/`
    window.__ROUTE_CTX__ = {{ route_ctx|safe }};

  {# SAFELY inject JSON; ok if 'route_ctx' is missing — the script below handles it #}
  {{ route_ctx|json_script:"route-ctx" }}

  <script>
    // Bootstrap a usable context + build a wsUrl fallback from data-delivery-id
    (function () {
      let ctx = {};
      try {
        const node = document.getElementById('route-ctx');
        ctx = node ? JSON.parse(node.textContent || '{}') : {};
      } catch (e) {
        ctx = {};
      }

      // Only build wsUrl if not provided by the server
      const mapEl = document.getElementById('map');
      const deliveryId = mapEl && mapEl.dataset ? mapEl.dataset.deliveryId : null;

      if (!ctx.wsUrl && deliveryId) {
        const scheme = (location.protocol === 'https:') ? 'wss' : 'ws';
        // Ensure trailing slash because your routing expects it
        ctx.wsUrl = `${scheme}://${location.host}/ws/delivery/track/${deliveryId}/`;
      }

      // Expose for the tracking script
      window.__ROUTE_CTX__ = ctx;
    })();

  </script>

  {# Your map/WS bootstrap — make sure this file exists #}
<<<<<<< HEAD

=======
>>>>>>> development
  <script defer src="{% static 'js/tracking-route.js' %}"></script>
{% endblock %}
