{% extends "base.html" %}
{% load static %}

{% block title %}Driver Live — #{{ delivery_id }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto p-4 md:p-6 space-y-5">

  <!-- Header -->
  <div class="flex items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
        Driver Live — <span class="text-blue-600">#{{ delivery_id }}</span>
      </h1>
      <p class="text-sm text-gray-500">Stream your location to the order in real time.</p>
    </div>

    <!-- WS chip -->
    <div id="chip-conn"
         class="inline-flex items-center gap-2 rounded-full px-3 py-1 border text-xs font-medium bg-white/70 backdrop-blur">
      <span id="chip-dot" class="h-2.5 w-2.5 rounded-full bg-gray-300"></span>
      <span id="chip-label" class="text-gray-700">WS: idle</span>
    </div>
  </div>

  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-2">
    <button id="btn-start"
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 active:scale-[.99]">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      Go Live
    </button>

    <button id="btn-stop"
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50"
            disabled>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
      Stop
    </button>

    <button id="btn-sim"
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
            title="Send demo moves without GPS">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h2v2H4zM18 18h2v2h-2zM6 6h6v2H6zM12 6l6 6-1.4 1.4L10.6 7.4z"/></svg>
      Simulate
    </button>

    <label class="inline-flex items-center gap-2 ml-auto text-sm">
      <input id="persist-toggle" type="checkbox" class="size-4 accent-blue-600">
      Persist to DB (HTTP)
    </label>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="rounded-2xl border p-3 bg-white/60">
      <div class="text-xs text-gray-500">Sent</div>
      <div id="stat-sent" class="text-lg font-semibold">0</div>
    </div>
    <div class="rounded-2xl border p-3 bg-white/60">
      <div class="text-xs text-gray-500">Last move</div>
      <div id="stat-last-m" class="text-lg font-semibold">–</div>
    </div>
    <div class="rounded-2xl border p-3 bg-white/60">
      <div class="text-xs text-gray-500">Accuracy</div>
      <div id="stat-acc" class="text-lg font-semibold">–</div>
    </div>
    <div class="rounded-2xl border p-3 bg-white/60">
      <div class="text-xs text-gray-500">Speed</div>
      <div id="stat-speed" class="text-lg font-semibold">–</div>
    </div>
  </div>

  <!-- Map -->
  <div class="rounded-2xl border overflow-hidden bg-white/60">
    <div id="map" class="w-full h-[70vh] min-h-[360px]"></div>
  </div>

  <!-- Debug -->
  <details id="debug-wrap" class="rounded-2xl border bg-white/60 p-2" open>
    <summary class="cursor-pointer select-none text-sm font-semibold">Debug</summary>
    <pre id="debug" class="text-xs overflow-auto max-h-56 p-2"></pre>
  </details>

</div>
{% endblock %}

{% block extra_js %}
  {# Leaflet #}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  {# Tiny CSP-safe boot payload only (logic lives in static/js/driver-live.js) #}
  <script nonce="{{ request.csp_nonce }}">
    window.DRIVER_LIVE_BOOT = {
      deliveryId: {{ delivery_id|default:"0" }},
      start: {
        lat: parseFloat("{{ start_lat|default:'-1.286389' }}"),
        lng: parseFloat("{{ start_lng|default:'36.817223' }}")
      },
      wsBase: (location.protocol === "https:" ? "wss://" : "ws://") + location.host,
      persistUrl: "/api/deliveries/{{ delivery_id|default:'0' }}/loc"  // adjust if your endpoint differs
    };
  </script>

  <script defer src="{% static 'js/driver-live.js' %}"></script>
{% endblock %}
