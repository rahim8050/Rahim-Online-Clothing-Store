{% extends "base.html" %}

{% block title %}My Orders{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-blue-600 mb-4">My Orders</h1>

    {% if orders %}
        <div class="space-y-4">
            {% for order in orders %}
                <div class="border rounded-lg p-4 shadow-sm">
                    <p><span class="font-semibold">Order ID:</span> {{ order.id }}</p>
                    <p><span class="font-semibold">Placed on:</span> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                    <p><span class="font-semibold">Status:</span>
                        {% if order.paid %}
                            <span class="text-green-600 font-medium">Paid</span>
                        {% else %}
                            <span class="text-red-500 font-medium">Pending</span>
                        {% endif %}
                    </p>
                    <p><span class="font-semibold">Address:</span> {{ order.address }}</p>

                    {% for item in order.items.all %}
                        <div class="border rounded p-2 mt-2">
                            <p>{{ item.quantity }} x {{ item.product.name }}</p>
                            <p class="text-sm">Delivery status: {{ item.delivery_status }}</p>
                            {% if item.delivery_status == "dispatched" %}
                                <button class="mt-1 text-blue-600 text-sm underline track-item-btn"
                                        data-order-id="{{ order.id }}"
                                        data-item-id="{{ item.id }}"
                                        data-clat="{{ order.latitude }}"
                                        data-clng="{{ order.longitude }}">
                                    Track Item
                                </button>
                                <div id="map-{{ order.id }}-{{ item.id }}" class="w-full rounded border mt-2 hidden" style="height:300px;"></div>
                                <p id="status-{{ order.id }}-{{ item.id }}" class="text-sm mt-2"></p>
                            {% else %}
                                <p class="text-sm text-gray-500 mt-1">Tracking not available.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500">You have no orders yet.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(() => {
  const states = new Map(); // key: mapDiv.id -> {map, marker, socket}

  document.querySelectorAll('.track-item-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orderId = btn.dataset.orderId;
      const itemId  = btn.dataset.itemId;
      const clat    = parseFloat(btn.dataset.clat);
      const clng    = parseFloat(btn.dataset.clng);

      const mapDivId = `map-${orderId}-${itemId}`;
      const mapDiv   = document.getElementById(mapDivId);
      const statusEl = document.getElementById(`status-${orderId}-${itemId}`);

      // Toggle map visibility
      const showing = mapDiv.classList.contains('hidden');
      mapDiv.classList.toggle('hidden');

      if (!showing) {
        // Hide: close socket to avoid leaks
        const st = states.get(mapDivId);
        if (st && st.socket && st.socket.readyState <= 1) {
          try { st.socket.close(); } catch(_) {}
        }
        return;
      }

      // Make sure map container is positioned
      mapDiv.style.position = mapDiv.style.position || 'relative';

      let st = states.get(mapDivId);
      if (!st) {
        // Create map
        const map = L.map(mapDiv, {
          center: [clat, clng],
          zoom: 13,
          worldCopyJump: true,   // wrap horizontally
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          noWrap: false,         // allow wrap
          continuousWorld: true, // repeat tiles horizontally
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Remove any bounds restrictions
        if (map.setMaxBounds) map.setMaxBounds(null);

        // Truck icon
        const truckIcon = L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/1557/1557523.png',
          iconSize: [32, 32],
          iconAnchor: [16, 16],
        });

        const marker = L.marker([clat, clng], { icon: truckIcon }).addTo(map);

        // WebSocket
        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/track/${orderId}/${itemId}/`);

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data || '{}');
          if (data.latitude != null && data.longitude != null) {
            const latlng = [data.latitude, data.longitude];
            marker.setLatLng(latlng);
            // Always center on marker
            map.setView(latlng);
          }
          if (data.status && statusEl) {
            statusEl.textContent = data.status;
          }
        };

        socket.onerror = (e) => console.warn('WS error:', e);
        st = { map, marker, socket };
        states.set(mapDivId, st);
      } else {
        // Reopen existing map
        st.map.invalidateSize();
        if (!st.socket || st.socket.readyState > 1) {
          const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
          const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/track/${orderId}/${itemId}/`);
          socket.onmessage = (event) => {
            const data = JSON.parse(event.data || '{}');
            if (data.latitude != null && data.longitude != null) {
              const latlng = [data.latitude, data.longitude];
              st.marker.setLatLng(latlng);
              st.map.setView(latlng);
            }
            if (data.status && statusEl) {
              statusEl.textContent = data.status;
            }
          };
          socket.onerror = (e) => console.warn('WS error:', e);
          st.socket = socket;
        }
      }
    });
  });
})();
</script>


{% endblock %}