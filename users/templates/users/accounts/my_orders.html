{% extends "base.html" %}

{% block title %}My Orders{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-blue-600 mb-4">My Orders</h1>

    {% if orders %}
        <div class="space-y-4">
            {% for order in orders %}
                <div class="border rounded-lg p-4 shadow-sm">
                    <p><span class="font-semibold">Order ID:</span> {{ order.id }}</p>
                    <p><span class="font-semibold">Placed on:</span> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                    <p><span class="font-semibold">Status:</span>
                        {% if order.paid %}
                            {% if order.last_tx and order.last_tx.callback_received %}
                                <span class="text-green-600 font-medium">Paid (verified)</span>
                            {% else %}
                                <span class="text-yellow-600 font-medium">Paid (awaiting confirmation)</span>
                            {% endif %}
                        {% else %}
                            <span class="text-red-500 font-medium">Awaiting Payment</span>
                        {% endif %}
                    </p>
                    <p><span class="font-semibold">Address:</span> {{ order.address }}</p>

                    {% for item in order.items.all %}
                        <div class="border rounded p-2 mt-2">
                            <p>{{ item.quantity }} x {{ item.product.name }}</p>
                            <p class="text-sm">Delivery status: {{ item.delivery_status }}</p>
                            <button class="track-item-btn" data-order-id="{{ order.id }}" data-item-id="{{ item.id }}" data-clat="{{ order.latitude|default_if_none:'' }}" data-clng="{{ order.longitude|default_if_none:'' }}">Track</button>
                            <div id="map-{{ order.id }}-{{ item.id }}" class="w-full h-64 rounded hidden"></div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500">You have no orders yet.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
(function () {
  const wsScheme = location.protocol === 'https:' ? 'wss' : 'ws';

  function buildMap(div) {
    if (!div.style.height || div.clientHeight < 50) div.style.height = '256px';
    const map = L.map(div).setView([-1.286389, 36.817223], 12);
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
    tiles.addTo(map);
    tiles.on('tileerror', (e) => console.warn('Tile error', e));
    // Important: recalc size after becoming visible
    setTimeout(() => map.invalidateSize(), 0);
    return map;
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.track-item-btn');
    if (!btn) return;

    const orderId = btn.dataset.orderId;
    const itemId  = btn.dataset.itemId;
    const lat = parseFloat(btn.dataset.clat);
    const lng = parseFloat(btn.dataset.clng);

    const mapDiv = document.getElementById(`map-${orderId}-${itemId}`);
    if (!mapDiv) return console.warn('No map div');
    if (isNaN(lat) || isNaN(lng)) {
      mapDiv.textContent = 'Missing destination coordinates.';
      return;
    }

    // 1) Show first, then build/resize
    mapDiv.classList.remove('hidden');
    let map = mapDiv._map;
    if (!map) {
      map = buildMap(mapDiv);
      mapDiv._map = map;
    } else {
      setTimeout(() => map.invalidateSize(), 0);
    }

    const ws = new WebSocket(`${wsScheme}://${location.host}/ws/track/${orderId}/${itemId}/`);
    let marker = mapDiv._marker;

    ws.onmessage = (e) => {
      try {
        const d = JSON.parse(e.data);
        if (d.type === 'tick' && d.lat && d.lng) {
          if (!marker) {
            marker = L.marker([d.lat, d.lng]).addTo(map);
            mapDiv._marker = marker;
          } else {
            marker.setLatLng([d.lat, d.lng]);
          }
          map.setView([d.lat, d.lng]);
        } else if (d.type === 'error') {
          mapDiv.textContent = `${d.code}: ${d.message}`;
          ws.close();
        }
      } catch {}
    };
    ws.onclose = (e) => {
      if (e.code >= 4000) {
        mapDiv.textContent += ` (socket closed ${e.code})`;
      }
      console.log('WS CLOSE', e.code);
    };
  });
})();
</script>


{% endblock %}
