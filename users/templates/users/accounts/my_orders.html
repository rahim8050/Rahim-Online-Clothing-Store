{% extends "base.html" %}

{% block title %}My Orders{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-blue-600 mb-4">My Orders</h1>

    {% if orders %}
        <div class="space-y-4">
            {% for order in orders %}
                <div class="border rounded-lg p-4 shadow-sm">
                    <p><span class="font-semibold">Order ID:</span> {{ order.id }}</p>
                    <p><span class="font-semibold">Placed on:</span> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                    <p><span class="font-semibold">Status:</span>
                        {% if order.paid %}
                            {% if order.last_tx and order.last_tx.callback_received %}
                                <span class="text-green-600 font-medium">Paid (verified)</span>
                            {% else %}
                                <span class="text-yellow-600 font-medium">Paid (awaiting confirmation)</span>
                            {% endif %}
                        {% else %}
                            <span class="text-red-500 font-medium">Awaiting Payment</span>
                        {% endif %}
                    </p>
                    <p><span class="font-semibold">Address:</span> {{ order.address }}</p>

                    {% for item in order.items.all %}
                        <div class="border rounded p-2 mt-2">
                            <p>{{ item.quantity }} x {{ item.product.name }}</p>
                            <p class="text-sm">Delivery status: {{ item.delivery_status }}</p>
                            {% if item.delivery_status == "dispatched" %}
                                <button class="mt-1 text-blue-600 text-sm underline track-item-btn"
                                        data-order-id="{{ order.id }}"
                                        data-item-id="{{ item.id }}">
                                    Track Item
                                </button>
                                <div id="map-{{ order.id }}-{{ item.id }}" class="w-full rounded border mt-2 hidden" style="height:300px;"></div>
                                <p id="status-{{ order.id }}-{{ item.id }}" class="text-sm mt-2"></p>
                            {% else %}
                                <p class="text-sm text-gray-500 mt-1">Tracking not available.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500">You have no orders yet.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(() => {
  const states = new Map();

  document.querySelectorAll('.track-item-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orderId = btn.dataset.orderId;
      const itemId  = btn.dataset.itemId;

      const mapDivId = `map-${orderId}-${itemId}`;
      const mapDiv   = document.getElementById(mapDivId);
      const statusEl = document.getElementById(`status-${orderId}-${itemId}`);

      const showing = mapDiv.classList.contains('hidden');
      mapDiv.classList.toggle('hidden');

      if (!showing) {
        const st = states.get(mapDivId);
        if (st && st.socket && st.socket.readyState <= 1) {
          try { st.socket.close(); } catch(_) {}
        }
        return;
      }

      let st = states.get(mapDivId);
      if (!st) {
        const map = L.map(mapDiv, { zoom: 13, worldCopyJump: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          noWrap: false,
          continuousWorld: true,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const truckIcon = L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/1557/1557523.png',
          iconSize: [32, 32],
          iconAnchor: [16, 16],
        });

        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/track/${orderId}/${itemId}/`);

        st = { map, truckIcon, socket };
        states.set(mapDivId, st);

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data || '{}');
          if (data.type === 'init') {
            const wh = [data.warehouse.latitude, data.warehouse.longitude];
            const dest = [data.destination.latitude, data.destination.longitude];
            st.map.setView(wh, 13);
            st.whMarker = L.marker(wh).addTo(st.map);
            st.destMarker = L.marker(dest).addTo(st.map);
            st.route = L.polyline([wh, dest], {color: 'blue'}).addTo(st.map);
            st.marker = L.marker(wh, { icon: st.truckIcon }).addTo(st.map);
            if (statusEl) statusEl.textContent = data.status;
          } else if (data.type === 'tick') {
            const latlng = [data.latitude, data.longitude];
            if (st.marker) st.marker.setLatLng(latlng);
            if (statusEl) statusEl.textContent = data.status;
          } else if (data.type === 'complete') {
            const latlng = [data.latitude, data.longitude];
            if (st.marker) st.marker.setLatLng(latlng);
            if (statusEl) statusEl.textContent = data.status;
            socket.close();
          }
        };

        socket.onerror = (e) => console.warn('WS error:', e);
      } else {
        st.map.invalidateSize();
        if (!st.socket || st.socket.readyState > 1) {
          const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
          const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/track/${orderId}/${itemId}/`);
          st.socket = socket;
          socket.onmessage = (event) => {
            const data = JSON.parse(event.data || '{}');
            if (data.type === 'init') {
              const wh = [data.warehouse.latitude, data.warehouse.longitude];
              const dest = [data.destination.latitude, data.destination.longitude];
              st.map.setView(wh, 13);
              st.whMarker = L.marker(wh).addTo(st.map);
              st.destMarker = L.marker(dest).addTo(st.map);
              st.route = L.polyline([wh, dest], {color: 'blue'}).addTo(st.map);
              st.marker = L.marker(wh, { icon: st.truckIcon }).addTo(st.map);
            } else if (data.type === 'tick' || data.type === 'complete') {
              const latlng = [data.latitude, data.longitude];
              if (st.marker) st.marker.setLatLng(latlng);
              if (data.type === 'complete') socket.close();
            }
            if (statusEl && data.status) statusEl.textContent = data.status;
          };
          socket.onerror = (e) => console.warn('WS error:', e);
        }
      }
    });
  });
})();
</script>
{% endblock %}
