{% extends "base.html" %}

{% block title %}My Orders{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-blue-600 mb-4">My Orders</h1>

    {% if orders %}
        <div class="space-y-4">
            {% for order in orders %}
                <div class="border rounded-lg p-4 shadow-sm">
                    <p><span class="font-semibold">Order ID:</span> {{ order.id }}</p>
                    <p><span class="font-semibold">Placed on:</span> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                    <p><span class="font-semibold">Status:</span>
                        {% if order.paid %}
                            <span class="text-green-600 font-medium">Paid</span>
                        {% else %}
                            <span class="text-red-500 font-medium">Pending</span>
                        {% endif %}
                    </p>
                    <p><span class="font-semibold">Address:</span> {{ order.address }}</p>

                    {% for item in order.items.all %}
                        <div class="border rounded p-2 mt-2">
                            <p>{{ item.quantity }} x {{ item.product.name }}</p>
                            {% if item.warehouse and order.latitude and order.longitude %}
                                <button class="mt-1 text-blue-600 text-sm underline track-item-btn"
                                        data-order-id="{{ order.id }}"
                                        data-item-id="{{ item.id }}"
                                        data-wlat="{{ item.warehouse.latitude }}"
                                        data-wlng="{{ item.warehouse.longitude }}"
                                        data-clat="{{ order.latitude }}"
                                        data-clng="{{ order.longitude }}">
                                    Track Item
                                </button>
                                <div id="map-{{ order.id }}-{{ item.id }}" class="w-full rounded border mt-2 hidden" style="height:300px;"></div>
                            {% else %}
                                <p class="text-sm text-gray-500 mt-1">Tracking not available.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500">You have no orders yet.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const geoapifyKey = "{{ geoapify_api_key }}";
document.querySelectorAll('.track-item-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const orderId = this.dataset.orderId;
        const itemId = this.dataset.itemId;
        const wlat = parseFloat(this.dataset.wlat);
        const wlng = parseFloat(this.dataset.wlng);
        const clat = parseFloat(this.dataset.clat);
        const clng = parseFloat(this.dataset.clng);
        const mapDiv = document.getElementById(`map-${orderId}-${itemId}`);
        if (mapDiv.classList.contains('hidden')) {
            mapDiv.classList.remove('hidden');
            if (!mapDiv.dataset.mapLoaded) {
                const map = L.map(mapDiv).setView([clat, clng], 6);
                L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-carto/{z}/{x}/{y}.png?apiKey=${geoapifyKey}`, {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                L.marker([wlat, wlng]).addTo(map).bindPopup('Warehouse');
                L.marker([clat, clng]).addTo(map).bindPopup('Destination');
                L.polyline([[wlat, wlng], [clat, clng]], {color: 'blue'}).addTo(map);
                map.fitBounds([[wlat, wlng], [clat, clng]]);
                mapDiv.dataset.mapLoaded = true;
            }
        } else {
            mapDiv.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}