{% extends "base.html" %}

{% block title %}My Orders{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-blue-600 mb-4">My Orders</h1>

    {% if orders %}
        <div class="space-y-4">
            {% for order in orders %}
                <div class="border rounded-lg p-4 shadow-sm">
                    <p><span class="font-semibold">Order ID:</span> {{ order.id }}</p>
                    <p><span class="font-semibold">Placed on:</span> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                    <p><span class="font-semibold">Status:</span>
                        {% if order.paid %}
                            {% if order.last_tx and order.last_tx.callback_received %}
                                <span class="text-green-600 font-medium">Paid (verified)</span>
                            {% else %}
                                <span class="text-yellow-600 font-medium">Paid (awaiting confirmation)</span>
                            {% endif %}
                        {% else %}
                            <span class="text-red-500 font-medium">Awaiting Payment</span>
                        {% endif %}
                    </p>
                    <p><span class="font-semibold">Address:</span> {{ order.address }}</p>

                    {% for item in order.items.all %}
                        <div class="border rounded p-2 mt-2">
                            <p>{{ item.quantity }} x {{ item.product.name }}</p>
                            <p class="text-sm">Delivery status: {{ item.delivery_status }}</p>
                            {% if item.delivery_status == "dispatched" %}
                                <button class="mt-1 text-blue-600 text-sm underline track-item-btn"
                                        data-order-id="{{ order.id }}"
                                        data-item-id="{{ item.id }}">
                                    Track Item
                                </button>
                                <div id="map-{{ order.id }}-{{ item.id }}" class="w-full rounded border mt-2 hidden" style="height:300px;"></div>
                                <p id="status-{{ order.id }}-{{ item.id }}" class="text-sm mt-2"></p>
                            {% else %}
                                <p class="text-sm text-gray-500 mt-1">Tracking not available.</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500">You have no orders yet.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
  const maps = {};      // mapDivId -> {map, marker}
  const sockets = {};   // "order:item" -> WebSocket

  function ensureVisible(div) {
    div.classList.remove('hidden');
    if (!div.style.height) div.style.height = '256px';
  }
  function isNum(x){ return Number.isFinite(Number(x)); }

  function initMap(mapDiv, lat, lng) {
    ensureVisible(mapDiv);
    lat = Number(lat); lng = Number(lng);
    if (!isNum(lat) || !isNum(lng)) {
      console.error("Bad init coords", lat, lng);
      mapDiv.innerHTML = `<div class="p-3 text-red-600">Invalid coordinates</div>`;
      return null;
    }
    const m = L.map(mapDiv, { center:[lat,lng], zoom:13, zoomControl:true, attributionControl:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(m);
    const marker = L.marker([lat,lng]).addTo(m);
    setTimeout(()=>m.invalidateSize(), 0);  // fixes blank tiles after unhide
    return {map:m, marker};
  }

  function connectTrack(orderId, itemId) {
    const mapDivId = `map-${orderId}-${itemId}`;
    const mapDiv   = document.getElementById(mapDivId);
    if (!mapDiv) return console.error("Missing map div", mapDivId);
    ensureVisible(mapDiv);

    // reuse socket if already open
    const key = `${orderId}:${itemId}`;
    if (sockets[key] && sockets[key].readyState === WebSocket.OPEN) {
      console.log("WS already open", key);
      return;
    }

    const scheme = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${scheme}://${location.host}/ws/track/${orderId}/${itemId}/`);
    sockets[key] = ws;

    ws.onopen = () => console.log("WS OPEN", key);
    ws.onmessage = (e) => {
      let msg = null;
      try { msg = JSON.parse(e.data); } catch { console.log("WS TEXT", e.data); return; }
      console.log("WS JSON", key, msg);

      if (msg.type === "error") {
        mapDiv.innerHTML = `<div class="p-3 text-red-600">Tracking error: ${msg.message || msg.code}</div>`;
        return;
      }

      if (msg.type === "init") {
        const start = msg.warehouse || {};
        const entry = initMap(mapDiv, start.latitude, start.longitude);
        if (entry) maps[mapDivId] = entry;
        return;
      }

      if (msg.type === "tick") {
        const entry = maps[mapDivId];
        if (entry && isNum(msg.latitude) && isNum(msg.longitude)) {
          entry.marker.setLatLng([msg.latitude, msg.longitude]);
          // optional: keep map centered
          // entry.map.setView([msg.latitude, msg.longitude]);
        }
        return;
      }

      if (msg.type === "complete") {
        const entry = maps[mapDivId];
        if (entry && isNum(msg.latitude) && isNum(msg.longitude)) {
          entry.marker.setLatLng([msg.latitude, msg.longitude]);
        }
        try { ws.close(); } catch {}
        return;
      }
    };

    ws.onerror = (e) => console.warn("WS ERROR", key, e);
    ws.onclose = (e) => console.log("WS CLOSE", key, e.code, e.reason);
  }

  // Hook your "Track" buttons
  document.querySelectorAll('.track-item-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const orderId = this.dataset.orderId;
      const itemId  = this.dataset.itemId;
      connectTrack(orderId, itemId);
    });
  });
})();
</script>
{% endblock %}
