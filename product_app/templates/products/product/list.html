{% extends "base.html" %}
{% load static %}

{% block title %}Rahim Online - All Products{% endblock %}

{% block content %}
<!-- Safe JSON data (no inline JS execution) -->
<script id="initial-data" type="application/json" nonce="{{ request.csp_nonce }}">
  {{ initial_data_json|safe }}
</script>

<div id="productApp" class="container mx-auto p-4 flex">
    <!-- Sidebar -->
    <aside class="w-full md:w-[16%] p-4">
        <h2 class="font-bold mb-2">Categories:</h2>
        <select v-model="selectedCategory" @change="filterByCategory"
                class="block w-full border border-gray-300 rounded-md p-2 text-sm focus:ring focus:ring-orange-200 text-orange-600">
            <option value="">All Categories</option>
            <option v-for="c in categories" :value="c.slug" :key="c.id">[[ c.name ]]</option>
        </select>

        <h2 class="font-bold mt-4">Sort By:</h2>
        <select v-model="sortOption" @change="sortProducts"
                class="block w-full border border-gray-300 rounded-md p-2 text-sm mt-2">
            <option value="price_asc">Price: Low to High</option>
            <option value="price_desc">Price: High to Low</option>
        </select>
    </aside>

    <!-- Main Product Grid -->
    <main class="w-[84%] p-4">
        <div class="mb-6">
            <input type="text" v-model="searchQuery" @input="searchProducts" placeholder="Search products..."
                   class="w-full border border-gray-300 rounded-md p-2 text-sm" />
            <h2 class="font-bold mt-4">[[ headerText ]]</h2>
        </div>

        <!-- Product Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <div v-for="product in displayedProducts"
                 :key="product.id"
                 class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300"
                 :class="{ 'shadow-xl scale-105': hoveredProductId === product.id }"
                 @mouseenter="handleMouseEnter(product.id)"
                 @mouseleave="handleMouseLeave">

                <a :href="product.detail_url">
                    <div class="h-56 w-full overflow-hidden">
                        <img v-if="product.image_url"
                             :src="product.image_url"
                             :alt="product.name"
                             class="h-full w-full object-cover" />
                        <div v-else class="h-56 bg-gray-200 flex items-center justify-center text-gray-600">
                            No Image Available
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 truncate">[[ product.name ]]</h3>
                        <p class="text-sm text-gray-500 mt-1 truncate">
                            [[ product.description || 'No description available' ]]
                        </p>
                        <p class="text-indigo-600 font-bold mt-2">Ksh [[ product.price ]]</p>
                    </div>
                </a>
            </div>
        </div>
    </main>
</div>

<!-- Vue + External Products Script -->
<script src="https://cdn.jsdelivr.net/npm/vue@2" defer></script>
<script src="{% static 'js/products.js' %}"defer></script>
{% endblock %}
