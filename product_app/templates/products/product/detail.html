{% extends 'base.html' %}
{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div id="product-app" class="min-h-screen flex items-center justify-center bg-gray-50 py-10 px-4">
    <div class="bg-white rounded-xl shadow-xl overflow-hidden w-full max-w-4xl flex flex-col md:flex-row transition"
         :class="{ 'shadow-2xl': isHovered }"
         @mouseenter="isHovered = true"
         @mouseleave="isHovered = false">

        <!-- Image Section -->
        <div class="w-full md:w-1/2">
            {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                 class="w-full h-full object-cover rounded-t-xl md:rounded-l-xl md:rounded-tr-none">
            {% else %}
            <div class="bg-gray-100 w-full h-64 flex items-center justify-center rounded-t-xl md:rounded-l-xl md:rounded-tr-none">
                <p class="text-gray-500">Image not available</p>
            </div>
            {% endif %}
        </div>

        <!-- Product Details Section -->
        <div class="w-full md:w-1/2 p-6 flex flex-col justify-between">
            <div>
                <h3 class="font-semibold text-2xl md:text-3xl mb-4">{{ productName }}</h3>
                <p class="text-indigo-600 text-xl md:text-2xl mb-6">{{ formattedPrice }}</p>

                <div class="mb-6">
                    <button @click="toggleDescription"
                            class="text-indigo-600 hover:text-indigo-800 bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg w-full md:w-auto transition-colors duration-300"
                            v-text="showDescription ? 'Hide Description' : 'Show Description'">
                    </button>
                    <div v-if="showDescription" class="bg-gray-50 p-4 rounded-lg mt-2">
                        <p class="text-gray-700 leading-relaxed" v-html="productDescription"></p>
                    </div>
                </div>
            </div>

            <form @submit.prevent="addToCart" class="mt-6">
                <button type="submit"
                        class="w-full md:w-auto text-white bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-lg transition-colors duration-300 text-sm md:text-base">
                    Add To Cart
                </button>
                <p class="mt-2 text-sm text-gray-600">{{ message }}</p>
            </form>
        </div>
    </div>
</div>

<!-- Inject product JSON -->
<script id="product-data" type="application/json">
    {{ product_json|safe }}
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;

createApp({
    data() {
        const productData = JSON.parse(document.getElementById('product-data').textContent);
        return {
            productName: productData.name,
            productPrice: productData.price,
            productDescription: productData.description,

            csrfToken: "{{ csrf_token }}",
            addToCartUrl: "{% url 'cart:cart_add' product.id %}",

            showDescription: false,
            isHovered: false,
            message: '',
            toastMessage: ''
        };
    },
    computed: {
        formattedPrice() {
            console.log('Raw productPrice:', this.productPrice);
            const price = parseFloat(this.productPrice);
            console.log('Parsed price:', price);
            if (isNaN(price)) {
                return 'Ksh 0.00';
            }
            return `Ksh ${price.toLocaleString('en-KE', { minimumFractionDigits: 2 })}`;
        }
    },
    methods: {
        toggleDescription() {
            this.showDescription = !this.showDescription;
        },
        async addToCart() {
            try {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', this.csrfToken);

                const response = await fetch(this.addToCartUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.csrfToken
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const data = await response.json();
                this.message = data.success ? data.message : 'Failed to add to cart';
                if (data.success) {
                    this.showToast('Added to cart!');
                    this.updateCartCounterDisplay();
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                this.message = 'Something went wrong. Please try again.';
                this.showToast('Failed to add to cart');
            }
        },
        showToast(msg) {
            this.toastMessage = msg;
            setTimeout(() => this.toastMessage = '', 3000);
        },
        async updateCartCounterDisplay() {
            try {
                const response = await fetch("/cart/count/");
                if (!response.ok) return;
                const data = await response.json();
                const counter = document.getElementById("cart-counter");
                if (counter) {
                    counter.textContent = data.count;
                }
            } catch (err) {
                console.error("Cart count update failed:", err);
            }
        }
    },
    mounted() {
        this.updateCartCounterDisplay();
    }
}).mount('#product-app');
</script>
{% endblock %}
